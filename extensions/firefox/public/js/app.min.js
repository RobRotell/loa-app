var Loa=(a=>(document.addEventListener("DOMContentLoaded",()=>{a.Forefront.init(),a.Background.init()}),a.Forefront={el:document.getElementById("loa_popup"),elUrlInput:null,elTagSelect:null,elSubmitBtn:null,elLoginBtn:null,elAuthInput:null,elNotice:null,isSubmitting:!1,init(){null!==this.el&&(this.elUrlInput=this.el.querySelector(".js-article-url"),this.elTagSelect=this.el.querySelector(".js-article-tag"),this.elSubmitBtn=this.el.querySelector(".js-article-submit"),this.elLoginBtn=this.el.querySelector(".js-login-btn"),this.elAuthInput=this.el.querySelector(".js-login-auth"),this.elNotice=this.el.querySelector(".js-notice"),browser.tabs.query({active:!0,currentWindow:!0}).then(a=>{a.length&&(this.elUrlInput.value=a[0].url)}),this.bind())},bind(){this.elUrlInput.addEventListener("keyup",this.resetUrlStates.bind(this)),this.elSubmitBtn.addEventListener("click",this.handleUrlSubmit.bind(this)),this.elLoginBtn.addEventListener("click",this.handleLoginBtnClick.bind(this)),this.elAuthInput.addEventListener("keyup",this.handleAuthInput.bind(this))},resetUrlStates(){this.elUrlInput.classList.remove("is-error","is-success"),this.elSubmitBtn.classList.remove("is-error","is-success"),this.showMessage(null,null,!1)},async handleUrlSubmit(){const b=this.elUrlInput.value,c=this.elTagSelect.value;if(this.resetUrlStates(),!b.length)return;if(!a.Background.isLoggedIn)return this.elSubmitBtn.classList.add("is-error"),void this.hintLogin();if(!/^(?:(?:(?:https?|ftp):)?\/\/)(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z0-9\u00a1-\uffff][a-z0-9\u00a1-\uffff_-]{0,62})?[a-z0-9\u00a1-\uffff]\.)+(?:[a-z\u00a1-\uffff]{2,}\.?))(?::\d{2,5})?(?:[/?#]\S*)?$/i.test(b))return this.elUrlInput.classList.add("is-error"),this.elSubmitBtn.classList.add("is-error"),void this.showMessage("Invalid URL!","error");if(this.isSubmitting)return;this.isSubmitting=!0,this.elSubmitBtn.classList.add("is-submitting");const d=await a.Background.addArticle(b,c);!0===d?(this.elSubmitBtn.classList.remove("is-submitting"),this.elSubmitBtn.classList.add("is-success"),this.elUrlInput.classList.add("is-success"),this.isSubmitting=!1,this.showMessage("Successfully added article!","success")):(console.warn(d),this.elSubmitBtn.classList.remove("is-submitting"),this.elUrlInput.classList.add("is-error"),this.isSubmitting=!1,"string"!==d&&(d="Failed to add article!"),this.showMessage(d,"error"))},handleLoginBtnClick(){const b=this.elAuthInput,c=b.classList.contains("is-active"),d=b.value;this.showMessage(),a.Background.isLoggedIn?this.triggerIsLoggedIn():d.length?this.submitAuthKey(d):b.classList.toggle("is-active",!c)},hintLogin(){this.elLoginBtn.classList.add("is-wiggling"),setTimeout(()=>this.elLoginBtn.classList.remove("is-wiggling"),2e3),this.showMessage("Log into app first!","warning")},handleAuthInput(a){const b=this.elAuthInput,c=b.value;b.classList.remove("is-error"),13===a.keyCode&&c.length&&this.submitAuthKey(c)},async submitAuthKey(b=""){if(b.length){const c=await a.Background.sendAuth(b);!0===c?(this.showMessage("Successfully logged in!","success"),this.triggerIsLoggedIn()):"string"==typeof c&&(console.warn(c),this.showMessage(c,"error"),this.elAuthInput.classList.add("is-error"))}},async triggerIsLoggedIn(){this.elSubmitBtn.classList.remove("is-error"),this.elAuthInput.classList.remove("is-active","is-error"),this.elLoginBtn.classList.add("is-logged-in");const b=await a.Background.getTags();this.loadTags(b)},loadTags(a=[]){Array.isArray(a)&&a.forEach(a=>{const b=document.createElement("option");b.value=a.id,b.text=a.name,this.elTagSelect.append(b)})},showMessage(a="",b="",c=!0){this.elNotice.innerText=a,this.elNotice.classList.toggle("is-success","success"===b),this.elNotice.classList.toggle("is-warning","warning"===b),this.elNotice.classList.toggle("is-error","error"===b),!0===c&&setTimeout(()=>{console.log("triggered"),this.elNotice.innerText="",this.elNotice.classList.remove("is-success","is-warning","is-error")},6e3)}},a.Background={endpoint:"https://api.loa.robr.app/wp-json/article-repo/v2",token:null,isLoggedIn:!1,storageKeyToken:"loaAuthToken",storageKeyTags:"loaArticleTags",async init(){const b=await this.getTokenFromStorage();if(!b)console.warn("No token saved locally");else{const c=await this.validateToken(b);c?(this.token=b,this.isLoggedIn=!0,a.Forefront.triggerIsLoggedIn()):browser.storage.local.remove(this.storageKeyToken)}},getTokenFromStorage(){return browser.storage.local.get(this.storageKeyToken).then(a=>{if("object"==typeof a&&a.hasOwnProperty(this.storageKeyToken)){a=a[this.storageKeyToken];const{token:b,expire:c}=a;if(void 0!==b&&!isNaN(c)&&!this.checkIfExpired(c))return b}return!1})},validateToken(a=""){if("string"!=typeof a||!a.length)return!1;else{const b=new URLSearchParams;return b.append("token",a),fetch(`${this.endpoint}/check-auth-token?${b.toString()}`).then(a=>a.json()).then(a=>{const{valid:b}=a;return"1"===b})}},sendAuth(a=""){if(this.isLoggedIn)return!0;if(!a.length)return!1;const b=new URLSearchParams;return b.append("auth_key",a),fetch(`${this.endpoint}/get-auth-token`,{body:b.toString(),method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(a=>a.json()).then(a=>{const{token:b,success:c}=a;if(!0===c&&"string"==typeof b&&b.length)return this.saveTokenToStorage(b),!0;else{const{error:b,message:c}=a;return!0===b&&"string"==typeof c&&c.length?c:(console.warn(a),"Failed to obtain token")}})},saveTokenToStorage(a=""){if(a.length){this.token=a;let b={};return b[this.storageKeyToken]={token:a,expire:this.getExpireTime()},browser.storage.local.set(b)}},async getTags(){let a=null;if(a=await this.getTagsFromStorage(),browser.storage.local.remove(this.storageKeyTags),!Array.isArray(a)&&this.token.length){const b=new URLSearchParams;b.append("token",this.token),a=fetch(`${this.endpoint}/get-tags?${b.toString()}`).then(a=>a.json()).then(a=>{const{tags:b,success:c}=a;if(!0===c&&"object"==typeof b){const a=[];for(let c in b)a.push({id:parseInt(c),name:b[c]});return this.saveTagsToStorage(a),a}})}return a},getTagsFromStorage(){return!!this.isLoggedIn&&browser.storage.local.get(this.storageKeyTags).then(a=>{if("object"==typeof a&&a.hasOwnProperty(this.storageKeyTags)){a=a[this.storageKeyTags];const{tags:b,expire:c}=a;if(void 0!==b&&!isNaN(c)&&!this.checkIfExpired(c))return b}return!1})},saveTagsToStorage(a=[]){let b={};return b[this.storageKeyTags]={tags:a,expire:this.getExpireTime()},browser.storage.local.set(b)},getExpireTime(){return 604800+Date.now()},checkIfExpired(a){return a<Date.now()},addArticle(a,b){if("string"!=typeof a||!a.length)return"Invalid URL!";const c=new URLSearchParams;return c.append("token",this.token),c.append("url",a),"string"==typeof b&&b.length&&(b=parseInt(b),!isNaN(b)&&c.append("tags",parseInt(b))),fetch(`${this.endpoint}/add-article`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:c.toString()}).then(a=>a.json()).then(a=>{const{success:b}=a;if(!0===b)return!0;else{const{error:b}=a;return"string"==typeof b&&b.length?b:"Failed to add article!"}})}},a))(Loa||{});